name: K8s Standards Validation

on:
  pull_request:
    paths:
      - 'k8s/**'
      - '.github/workflows/k8s-validation.yml'
  push:
    branches: [ master, main ]
    paths:
      - 'k8s/**'

jobs:
  k8s-standards-check:
    runs-on: ubuntu-latest
    name: Validate K8s Standards Compliance
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python and dependencies
      run: |
        python3 -m pip install --upgrade pip
        python3 -m pip install PyYAML
        
    - name: Validate YAML syntax
      run: |
        echo "üîç Validating YAML syntax for all k8s manifests..."
        for file in k8s/*.yaml k8s/*.yml; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            # Use yq to validate YAML syntax without requiring a cluster
            if command -v yq >/dev/null 2>&1; then
              yq eval '.' "$file" >/dev/null || exit 1
            else
              # Fallback to basic YAML validation with python
              python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
            fi
          fi
        done
        echo "‚úÖ All YAML files are syntactically valid"
        
    - name: Check Resource Limits (Rule 01)
      run: |
        echo "üîç Checking Rule 01: Resource Requests & Limits..."
        if ! grep -q "requests:" k8s/deployment.yaml; then
          echo "‚ùå Missing resource requests"
          exit 1
        fi
        if ! grep -q "limits:" k8s/deployment.yaml; then
          echo "‚ùå Missing resource limits"
          exit 1
        fi
        echo "‚úÖ Rule 01: Resource limits properly configured"
        
    - name: Check Security Context (Rule 02)
      run: |
        echo "üîç Checking Rule 02: Pod Security Baseline..."
        if ! grep -q "runAsNonRoot: true" k8s/deployment.yaml; then
          echo "‚ùå Missing runAsNonRoot: true"
          exit 1
        fi
        if ! grep -q "readOnlyRootFilesystem: true" k8s/deployment.yaml; then
          echo "‚ùå Missing readOnlyRootFilesystem: true"
          exit 1
        fi
        if ! grep -q 'drop: \["ALL"\]' k8s/deployment.yaml; then
          echo "‚ùå Missing capabilities drop ALL"
          exit 1
        fi
        echo "‚úÖ Rule 02: Security context properly configured"
        
    - name: Check Image Provenance (Rule 03)
      run: |
        echo "üîç Checking Rule 03: Image Provenance..."
        if grep -q ":latest" k8s/*.yaml; then
          echo "‚ùå Found :latest tag in manifests"
          exit 1
        fi
        if ! grep -q "@sha256:" k8s/deployment.yaml; then
          echo "‚ùå Missing SHA digest in image reference"
          exit 1
        fi
        echo "‚úÖ Rule 03: Image provenance properly configured"
        
    - name: Check Labels (Rule 04)
      run: |
        echo "üîç Checking Rule 04: Naming & Label Conventions..."
        required_labels=("app.kubernetes.io/name" "app.kubernetes.io/version" "app.kubernetes.io/part-of" "environment" "managed-by")
        for label in "${required_labels[@]}"; do
          if ! grep -q "$label:" k8s/deployment.yaml; then
            echo "‚ùå Missing required label: $label"
            exit 1
          fi
        done
        echo "‚úÖ Rule 04: Labels properly configured"
        
    - name: Standards Compliance Summary
      run: |
        echo "üéâ K8s Standards Compliance Check Complete!"
        echo "‚úÖ Rule 01: Resource Requests & Limits - PASSED"
        echo "‚úÖ Rule 02: Pod Security Baseline - PASSED"  
        echo "‚úÖ Rule 03: Image Provenance - PASSED"
        echo "‚úÖ Rule 04: Naming & Labels - PASSED"
        echo ""
        echo "üèÜ All k8s standards compliance checks passed successfully!"
